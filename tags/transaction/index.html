
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="">
    <title>Tag: transaction - null</title>
    <meta name="author" content="Moon Star">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="개발 정리 블로그">
<meta property="og:type" content="blog">
<meta property="og:title">
<meta property="og:url" content="https:&#x2F;&#x2F;suld2495.github.io&#x2F;code_repository&#x2F;tags&#x2F;transaction&#x2F;index.html">
<meta property="og:site_name">
<meta property="og:description" content="개발 정리 블로그">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Moon Star">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/code_repository/assets/css/all.css">

    
<link rel="stylesheet" href="/code_repository/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/code_repository/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/code_repository/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/code_repository/%20"
            aria-label=""
        >
            
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /code_repository/#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/code_repository/%20"
                            
                            title="홈"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">홈</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/code_repository/all-categories"
                            
                            title="카테고리"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/code_repository/all-tags"
                            
                            title="태그"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/code_repository/all-archives"
                            
                            title="아카이브"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="검색"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://facebook.com/" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/code_repository/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/code_repository/2019/12/20/java-datasourceutils/"
                            aria-label=": DataSourceUtils"
                        >
                            DataSourceUtils
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-12-20T16:23:25+09:00">
	
		    Dec 20, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/code_repository/categories/java/">java</a>, <a class="category-link" href="/code_repository/categories/java/api/">api</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h2><p>DataSource는 ConnectionPool을 관리하기 위한 목적으로 사용되는 객체로 DataSource를 통해서 Connection을 얻어오고 반납하는 등의 작업을 구현합니다. ConnectionPool에는 여러개의 Connection 객체가 생성되어 운용되는데, 이를 직접 웹 어플리케이션에서 다루기 힘들기 때문에 DataSource라는 개념이 도입되었습니다.</p>
<h2 id="DataSourceUtils"><a href="#DataSourceUtils" class="headerlink" title="DataSourceUtils"></a>DataSourceUtils</h2><p>DataSourceUtils 클래스는 JNDI에서 연결을 얻고 필요한 경우 연결을 닫는 메소드를 제공하는 기능을 제공 합니다. 그리고 DataSourceTransactionManager로 쓰레드에 기반한 연결을 지원합니다.</p>
<h2 id="DataSourceUtils에서-제공하는-메소드"><a href="#DataSourceUtils에서-제공하는-메소드" class="headerlink" title="DataSourceUtils에서 제공하는 메소드"></a>DataSourceUtils에서 제공하는 메소드</h2><h5 id="getConnection-DataSource-dataSource"><a href="#getConnection-DataSource-dataSource" class="headerlink" title="getConnection(DataSource dataSource)"></a>getConnection(DataSource dataSource)</h5><p>getConnection메소드는 제공 된 DataSource를 기반으로 하여 Connection을 생성해줍니다. Connection 생성은 트랜잭션 동기화 여부에 따라 다르게 작동합니다. 만약 트랜잭션 동기화가 활성화 되어 있다면 Connection을 생성하고 트랜잭션 저장소에 바인딩 합니다. 이후 트랜잭션 동기화 작업을 종료 할때까지 getConnection메소드를 호출하면 동일한 Connection을 반환하는 것을 확인할수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceUtilsTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionSynchronizationManager.initSynchronization();</span><br><span class="line"></span><br><span class="line">        Connection conn1 = DataSourceUtils.getConnection(dataSource);</span><br><span class="line">        Connection conn2 = DataSourceUtils.getConnection(dataSource);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"동일한 인스턴스 인가요? "</span> + conn1.equals(conn2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/code_repository/image/java-datasourceutils1.png" alt=""></p>
<p>트랜잭션이 동기화되어 있지 않을 경우에는 <code>dataSource.getConnection()</code>과 동일하게 작동합니다. 그래서 항상 새로운 Connection을 반환합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceUtilsTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection conn1 = DataSourceUtils.getConnection(dataSource);</span><br><span class="line">        Connection conn2 = DataSourceUtils.getConnection(dataSource);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"동일한 인스턴스 인가요? "</span> + conn1.equals(conn2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/code_repository/image/java-datasourceutils2.PNG" alt=""></p>
<h5 id="releaseConnection-Connection-conn-DataSource-dataSource"><a href="#releaseConnection-Connection-conn-DataSource-dataSource" class="headerlink" title="releaseConnection(Connection conn, DataSource dataSource)"></a>releaseConnection(Connection conn, DataSource dataSource)</h5><p>releaseConnection메소드 또한 getConnection와 비슷하게 동작 합니다. 만약 트랜잭션 동기화가 활성화 되어 있다면 트랜잭션 저장소에서 Connection을 초기화 합니다. 이때 Connection의 연결은 종료하지 않습니다. 그리고 release 후 다시 getConnection으로 Connection을 받아왔을때 동일한 값이라는 것을 확인 할수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceUtilsTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionSynchronizationManager.initSynchronization();</span><br><span class="line"></span><br><span class="line">        Connection conn = DataSourceUtils.getConnection(dataSource);</span><br><span class="line"></span><br><span class="line">        DataSourceUtils.releaseConnection(conn, dataSource);</span><br><span class="line">        System.out.println(<span class="string">"Connection이 종료 되었니? "</span> + conn.isClosed());</span><br><span class="line"></span><br><span class="line">        Connection conn2 = DataSourceUtils.getConnection(dataSource);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"동일한 Connection 인가요? "</span> + conn.equals(conn2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/code_repository/image/java-datasourceutils3.PNG" alt=""></p>
<p>위와 같이 releaseConnection 메소드를 호출 하더라도 Connection은 종료되지 않는다. 단지 트랜잭션에서만 제거되었을 뿐이다. 이 때문에 사용시 주의할 필요가 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceUtilsTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionSynchronizationManager.initSynchronization();</span><br><span class="line"></span><br><span class="line">        Connection conn = DataSourceUtils.getConnection(dataSource);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"트랜잭션 저장소에 저장 중인가? "</span> + DataSourceUtils.isConnectionTransactional(conn, dataSource));</span><br><span class="line"></span><br><span class="line">        DataSourceUtils.releaseConnection(conn, dataSource);</span><br><span class="line"></span><br><span class="line">        TransactionSynchronizationManager.unbindResource(dataSource);</span><br><span class="line">        TransactionSynchronizationManager.clearSynchronization();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Connection이 종료 되었니? "</span> + conn.isClosed());</span><br><span class="line">        System.out.println(<span class="string">"트랜잭션 저장소에 저장 중인가? "</span> + DataSourceUtils.isConnectionTransactional(conn, dataSource));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/code_repository/image/java-datasourceutils4.PNG" alt=""></p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>DataSourceUtils를 사용하면 동기화된 트랜잭션의 Connection을 가져와서 사용하기에 좋다. 하지만 releaseConnection은 Connection을 종료해주는 기능이 아니므로 사용시에 주의할 필요가 있다.</p>
<div class="alert info"><p>트랜잭션 동기화 상태가 아닌 Connection이라면 releaseConnection메소드를 호출하면 close 해준다.</p>
</div>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/code_repository/2019/12/20/java-datasourceutils/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Moon Star. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Moon Star</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/code_repository/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/code_repository/assets/js/jquery.js"></script>


<script src="/code_repository/assets/js/jquery.fancybox.js"></script>


<script src="/code_repository/assets/js/thumbs.js"></script>


<script src="/code_repository/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
